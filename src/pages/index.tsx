import Head from 'next/head';
import { Lato } from 'next/font/google';
import styles from '@/styles/Home.module.css';
import { BaseSyntheticEvent, useEffect, useRef, useState } from 'react';
import { WeatherProps } from '@/types/weather.types';
import { WeatherIcon } from '@/components/WeatherIcon';

// Icons
import { BsClouds, BsDropletHalf, BsWind } from 'react-icons/bs';
import { BiSearchAlt } from 'react-icons/bi';

const lato = Lato({ subsets: ['latin'], weight: '400' });

export default function Home() {
  const [search, setSearch] = useState<string | undefined>('');
  const [loc, setLoc] = useState({ lat: 44.34, lon: 10.99 });
  const [currentWeather, setCurrentWeather] = useState<WeatherProps>();
  const [searchLocations, setSearchLocations] = useState<any[]>([]);
  const searchInputRef = useRef<HTMLInputElement>(null);

  const handleSearchIconClick = () => {
    searchInputRef.current?.focus();
  };

  const handleSearchSubmit = (e: BaseSyntheticEvent) => {
    e.preventDefault();

    setSearch(searchInputRef?.current?.value);
  };

  const handleLocationClick = ({ lat, lon }) => {
    if (searchInputRef.current) {
      searchInputRef.current.value = '';
    }

    setSearchLocations([]);
    setLoc({ lat, lon });
  };

  useEffect(() => {
    navigator.geolocation.getCurrentPosition(function (position) {
      console.log(position.coords);
      setLoc({ lat: position.coords.latitude, lon: position.coords.longitude });
    });
  }, []);

  useEffect(() => {
    if (!loc) {
      return;
    }
    const fetchData = async () => {
      const response = await fetch(
        `/api/currentWeather?lat=${loc.lat}&lon=${loc.lon}`
      );
      const data = await response.json();

      if (data) {
        setCurrentWeather(data);
      }
    };

    fetchData();
  }, [loc]);

  useEffect(() => {
    if (!search) {
      return;
    }
    const fetchData = async () => {
      const response = await fetch(`/api/geoLocation?search=${search}`);
      const data = await response.json();

      if (data) {
        setSearchLocations(data);
      }
    };

    fetchData();
  }, [search]);

  return (
    <>
      <Head>
        <title>React Weather API App</title>
        <meta
          name="description"
          content="Generated by create next app"
        />
        <meta
          name="viewport"
          content="width=device-width, initial-scale=1"
        />
        <link
          rel="icon"
          href="/favicon.ico"
        />
      </Head>
      <main className={`${styles.main} ${lato.className}`}>
        <div className={styles.weather_container}>
          <form
            className={styles.weather_form}
            onSubmit={handleSearchSubmit}
          >
            <div className={styles.form_top_bar}>
              <span>{currentWeather?.location}</span>
              <input
                type="text"
                ref={searchInputRef}
                placeholder="Search by City"
              />
            </div>
            {searchLocations && (
              <ul className={styles.search_return_container}>
                {searchLocations.map((loc, idx) => {
                  return (
                    <li
                      key={idx}
                      onClick={() =>
                        handleLocationClick({
                          lat: loc.latitude,
                          lon: loc.longitude,
                        })
                      }
                    >
                      {loc.name}, {loc.countryCode}
                    </li>
                  );
                })}
              </ul>
            )}
          </form>
          <div className={styles.weather_type_container}>
            <WeatherIcon id={currentWeather?.weatherId} />
            <span>{currentWeather?.weatherType}</span>
          </div>
          <div className={styles.weather_info_container}>
            <ul className={styles.weather_info}>
              <li>
                <BsWind /> <span>{currentWeather?.windSpeed}</span>
              </li>
              <li>
                <BsDropletHalf /> <span>{currentWeather?.humidity}</span>
              </li>
              <li>
                <BsClouds /> <span>{currentWeather?.clouds}</span>
              </li>
            </ul>
            <div className={styles.weather_temperature}>
              {currentWeather?.currentTemp}
            </div>
          </div>
          <ul className={styles.day_selection_list}>
            <li className={`${styles.day} ${styles.day_active}`}>
              <button>S</button>
            </li>
            <li className={`${styles.day}`}>
              <button>M</button>
            </li>
            <li className={`${styles.day}`}>
              <button>T</button>
            </li>
            <li className={`${styles.day}`}>
              <button>W</button>
            </li>
            <li className={`${styles.day}`}>
              <button>T</button>
            </li>
            <li className={`${styles.day}`}>
              <button>F</button>
            </li>
            <li className={`${styles.day}`}>
              <button>S</button>
            </li>
          </ul>
          {/* <div className={styles.top_bar}>
            <div className={styles.location}>
              <p>{currentWeather?.location}</p>
            </div>
            <div className={styles.search_container}>
              <form onSubmit={(e) => handleSearchSubmit(e)}>
                <input
                  className={styles.search_input}
                  ref={searchInputRef}
                  type="text"
                  placeholder="search"
                />
              </form>
              <button
                className={styles.search_icon}
                onClick={handleSearchIconClick}
              >
                <BiSearchAlt size="1.5rem" />
              </button>
            </div>
          </div>
          {!!searchLocations && (
            <div className={styles.search_locations}>
              {searchLocations.map((item, idx) => {
                return (
                  <p
                    key={idx}
                    onClick={() =>
                      setLoc({
                        lat: item.latitude,
                        lon: item.longitude,
                      })
                    }
                  >
                    {item.name}, {item.countryCode}
                  </p>
                );
              })}
            </div>
          )}
          <div className={styles.weather_type_container}>
            <WeatherIcon id={currentWeather?.weatherId} />
            <p>{currentWeather?.weatherType}</p>
            <ul className={styles.day_selection_list}>
              <li className={`${styles.day} ${styles.day_active}`}>
                <button>S</button>
              </li>
              <li className={`${styles.day}`}>
                <button>M</button>
              </li>
              <li className={`${styles.day}`}>
                <button>T</button>
              </li>
              <li className={`${styles.day}`}>
                <button>W</button>
              </li>
              <li className={`${styles.day}`}>
                <button>T</button>
              </li>
              <li className={`${styles.day}`}>
                <button>F</button>
              </li>
              <li className={`${styles.day}`}>
                <button>S</button>
              </li>
            </ul>
          </div>
          <div className={styles.weather_info_container}>
            <div className={styles.weather_detail_wrapper}>
              <div className={styles.weather_detail}>
                <BsWind />
                <p>{currentWeather?.windSpeed}</p>
              </div>
              <div className={styles.weather_detail}>
                <BsDropletHalf />
                <p>{currentWeather?.humidity}</p>
              </div>
              <div className={styles.weather_detail}>
                <BsClouds />
                <p>{currentWeather?.clouds}</p>
              </div>
            </div>
            <div className={styles.temperature}>
              {currentWeather?.currentTemp}
            </div>
          </div> */}
        </div>
      </main>
    </>
  );
}
